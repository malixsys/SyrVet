<html ng-app="syrVetApp">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="initial-scale=1, maximum-scale=1, user-scalable=no, width=device-width">

  <title>Dealer Locator</title>

  <link href="http://code.ionicframework.com/1.0.0-beta.3/css/ionic.css" rel="stylesheet">
  <script src="http://code.ionicframework.com/1.0.0-beta.3/js/ionic.bundle.js"></script>
  <!--<script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>-->
  <script type="text/javascript"
          src="http://maps.googleapis.com/maps/api/js?v=3.exp&libraries=geometry,places&sensor=false">
  </script>
  <style>
    .map {
      border: 1px solid white;
      position: absolute;
      width: 100%;
      bottom: 0;
      top: 0;
    }

    .search {
      /*border: solid 1px black;*/
      position: fixed;
      bottom: 0px;
      left: 0px;
      width: 100%;
      height: 32px;
      margin: 0;
      background-color: rgba(255, 255, 255, 0.75)
    }

    span {
      font-size: 22px;
    }

    .search input {
      position: fixed;
      bottom: 1px;
      height: 30px;
      background: transparent;
      width: 100% margin : 0;
      margin-left: 130px;
      font-size: 22px;
      border: 1px solid grey;
    }
  </style>
</head>
<body>
<ui-view/>
<script type="text/ng-template" id="infoWindowTemplate">
  <div class="google-map">
    <h3>{{windowInfo.title}}</h3>
    <ul>
      <li><h4>{{windowInfo.address}}</h4></li>
      <li><b>Dist.: </b> {{windowInfo.distance}} km<br/>
        <b>Tel.: </b>{{windowInfo.telephone}}
      </li>
      <li style="float:right;"><button ng-click="OK()">OK</button>
      </li>
    </ul>
    <div style="clear: both;"></div>
  </div>
</script>
<script>
angular.module('syrVetApp', ['ionic', 'ui.router'])
    .config(
    [          '$stateProvider', '$urlRouterProvider',
      function($stateProvider, $urlRouterProvider) {
        $urlRouterProvider.otherwise(function($injector, $location) {
          $location.path('/');
        });
        $stateProvider
            .state("home", {
              url: '/',
              template: '<div class="map" searching="info.searching" dealers="info.dealers" search="info.search">Loading...</div><label class="search">' +
                  '<span ng-bind="info.label">Loading...</span><input ng-if="info.loaded" ng-disabled="info.searching" maxlength="3" type="text" ng-model="info.search" /> </label>',
              controller: 'MainCtrl'
            })

      }])
    .factory('Geo', [function() {
      return {
        distance: function(center, lat, lng) {
          return distVincenty(lat, lng, center[1], center[0]) / 1000;//45.440952, -73.671448);
          //http://geogratis.gc.ca/services/geolocation/fr/locate?q=H8S%20-73.671448,45.440952

        }
      }
      function toRad(n) {
        return n * Math.PI / 180;
      };
      function distVincenty(lat1, lon1, lat2, lon2) {
        var a = 6378137,
            b = 6356752.3142,
            f = 1 / 298.257223563, // WGS-84 ellipsoid params
            L = toRad(lon2 - lon1),
            U1 = Math.atan((1 - f) * Math.tan(toRad(lat1))),
            U2 = Math.atan((1 - f) * Math.tan(toRad(lat2))),
            sinU1 = Math.sin(U1),
            cosU1 = Math.cos(U1),
            sinU2 = Math.sin(U2),
            cosU2 = Math.cos(U2),
            lambda = L,
            lambdaP,
            iterLimit = 100;
        do {
          var sinLambda = Math.sin(lambda),
              cosLambda = Math.cos(lambda),
              sinSigma = Math.sqrt((cosU2 * sinLambda) * (cosU2 * sinLambda) + (cosU1 * sinU2 - sinU1 * cosU2 * cosLambda) * (cosU1 * sinU2 - sinU1 * cosU2 * cosLambda));
          if (0 === sinSigma) {
            return 0; // co-incident points
          }
          ;
          var cosSigma = sinU1 * sinU2 + cosU1 * cosU2 * cosLambda,
              sigma = Math.atan2(sinSigma, cosSigma),
              sinAlpha = cosU1 * cosU2 * sinLambda / sinSigma,
              cosSqAlpha = 1 - sinAlpha * sinAlpha,
              cos2SigmaM = cosSigma - 2 * sinU1 * sinU2 / cosSqAlpha,
              C = f / 16 * cosSqAlpha * (4 + f * (4 - 3 * cosSqAlpha));
          if (isNaN(cos2SigmaM)) {
            cos2SigmaM = 0; // equatorial line: cosSqAlpha = 0 (ยง6)
          }
          ;
          lambdaP = lambda;
          lambda = L + (1 - C) * f * sinAlpha * (sigma + C * sinSigma * (cos2SigmaM + C * cosSigma * (-1 + 2 * cos2SigmaM * cos2SigmaM)));
        } while (Math.abs(lambda - lambdaP) > 1e-12 && --iterLimit > 0);

        if (!iterLimit) {
          return NaN; // formula failed to converge
        }
        ;

        var uSq = cosSqAlpha * (a * a - b * b) / (b * b),
            A = 1 + uSq / 16384 * (4096 + uSq * (-768 + uSq * (320 - 175 * uSq))),
            B = uSq / 1024 * (256 + uSq * (-128 + uSq * (74 - 47 * uSq))),
            deltaSigma = B * sinSigma * (cos2SigmaM + B / 4 * (cosSigma * (-1 + 2 * cos2SigmaM * cos2SigmaM) - B / 6 * cos2SigmaM * (-3 + 4 * sinSigma * sinSigma) * (-3 + 4 * cos2SigmaM * cos2SigmaM))),
            s = b * A * (sigma - deltaSigma);
        return s.toFixed(3); // round to 1mm precision
      };

    }])
    .factory('Drive', ['$http', '$location', function($http, $location) {
      var supplier = $location.search().s || 'Thymox';
      return {
        geocode: function(code) {
          return $http.get('http://geogratis.gc.ca/services/geolocation/fr/locate?q=' + code)
              .then(function(response) {
                if (response.status !== 200 || !response.data || !response.data.length) {
                  return false;
                }
                var codes = response.data.filter(function(e) {
                  return e.type === "ca.gc.nrcan.geoloc.data.model.PostalCode";
                });
                if (codes && codes.length) {
                  var code = codes.shift();
                  return code && code.geometry && code.geometry.coordinates;
                }
                return false;
              });
        },
        load: function() {
          return $http.jsonp('https://spreadsheets.google.com/feeds/cells/1YvKLwJDLXlbSBcg6CPLQWhFDrcTJckAS3YYuLSeA11g/0/public/basic?alt=json-in-script&callback=JSON_CALLBACK')
              .then(function(response) {
                var cells = response && response.data && response.data.feed && response.data.feed.entry;
                cells = cells.reduce(function(m, c) {
                  var key = c.title.$t;
                  var RC = /([A-Za-z]+)(\d+)/gi.exec(key);
                  RC.shift();
                  var row = parseInt(RC[1], 10);
                  var col = RC[0].split('').reduce(function(m, l) {
                    var letter = l.charCodeAt(0) - 64;
                    return (m * 26) + letter;
                  }, 0);
                  var text = c.content.$t;

                  if (!m[row - 1]) {
                    m[row - 1] = [];
                  }
                  m[row - 1][col - 1] = text;
                  return m;
                }, []);
                cells = cells.filter(function(c) {
                  return c.shift() === supplier;
                })
                return cells;
              });
        }
      }
    }])
    .controller('MainCtrl', ['Drive', '$scope', function(Drive, $scope) {
      $scope.info = {
        label: 'Loading...',
        loaded: false,
        searching: false
      };
      Drive.load().then(function(dealers){
        $scope.info.dealers = dealers;
        $scope.info.label = 'Code Postal:';
        $scope.info.loaded = true;
      })
    }])
    .directive('map', ['$compile', '$templateCache', 'Geo', 'Drive', function($compile, $templateCache, Geo, Drive) {
      return {
        restrict: 'C',
        template: '<div>A</div>',
        replace: true,
        scope: {
          dealers: '=',
          search: '=',
          searching: '='
        },
        link: function(scope, ele, attrs) {

          var markers = [];

          function clearOverlays() {
            for (var i = 0; i < markers.length; i++) {
              markers[i].setMap(null);
            }
            markers.length = 0;
          }

          var latlng = new google.maps.LatLng(56.2571657, -94.2861328);//(45.8, -72);
          var myOptions = {
            zoom: 4,
            center: latlng,
            mapTypeId: google.maps.MapTypeId.ROADMAP
          };
          map = new google.maps.Map(ele[0], myOptions);

          var geocoder = new google.maps.Geocoder();

          scope.windowInfo = {
            title: 'window',
            desc: 'desc'
          }
          var infoWindowTemplate = $templateCache.get('infoWindowTemplate').trim();
          var infoWindowElem = $compile(infoWindowTemplate)(scope);
          window.infowindow = new google.maps.InfoWindow({
            content: infoWindowElem[0]
          });

          var center = [-94.2861328, 56.2571657];


          scope.$watch('search', function(a) {
            clearOverlays();
            if (a && 3 === a.length) {
              scope.searching = true;
              Drive.geocode(a).then(function(data) {
                scope.searching = false;
                if (!data) return;
                center = data;
                var marker = new google.maps.Marker({
                  map: map,
                  position: new google.maps.LatLng(data[1], data[0]),
                  title: a.toUpperCase(),
                  icon: 'http://maps.google.com/mapfiles/kml/shapes/arrow.png'
                });
                markers[markers.length] = marker;
                scope.OK = function () {
                  map.setCenter(marker.getPosition());
                  map.setZoom(8);
                  window.infowindow.close();
                }
                scope.dealers.forEach(mapDealer);
                scope.OK();
              });
            }
          });


          var delay = 10;

          function addMarker(dealer, lat, lng) {
            var dist = Geo.distance(center, lat, lng);
            console.log(dist);
            if (dist > 201) return;
            var marker = new google.maps.Marker({
              map: map,
              position: new google.maps.LatLng(lat, lng),
              title: dealer[0]
            });
            google.maps.event.addListener(
                marker, 'mousedown', function() {
                  map.setCenter(marker.getPosition());
                  map.setZoom(11);
                  scope.windowInfo.title = dealer[0];
                  scope.windowInfo.address = dealer[1].replace(', Canada','');
                  scope.windowInfo.telephone = dealer[2];
                  scope.windowInfo.distance = dist.toFixed(0)
                  scope.$apply();
                  window.infowindow.open(marker.get('map'), marker);
                });

            marker.infowindow = infowindow;
            markers[markers.length] = marker;
            marker.orderid = markers.length;
          }
          
          function mapDealer(dealer, index) {
            var found = !!(dealer, dealer[3] && dealer[3].length && dealer[4] && dealer[4].length && true);
            if (found) {
              delay += 10;
            } else {
              delay += 750;
            }
            setTimeout(function() {
              if (found && index !== 1) {
                addMarker(dealer, parseFloat(dealer[3]), parseFloat(dealer[4]));
              } else {
                var parts = dealer[1].split(/(?:,\s?)/gi);
                var options = {
                  'address': parts[0],
                  componentRestrictions: { administrativeArea: parts[2], postalCode: parts[1]}
                };
                if (parts[4] === 'Canada') {
                  options.componentRestrictions.country = 'CA';
                }
                geocoder.geocode(options, function(results, status) {
                  if (status == google.maps.GeocoderStatus.OK) {
                    dealer[3] = results[0].geometry.location.lat();
                    dealer[4] = results[0].geometry.location.lng();

                    addMarker(dealer, parseFloat(dealer[3]), parseFloat(dealer[4]));

                  } else {
                    console.log(arguments);
                  }
                });
              }
            }, delay);
          };

        }
      };
    }])
;
</script>
</body>
</html>

